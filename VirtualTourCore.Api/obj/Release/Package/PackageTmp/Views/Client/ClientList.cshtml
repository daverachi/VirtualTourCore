@model IEnumerable<VirtualTourCore.Api.Models.ClientVO>

@{
    ViewBag.Title = "Client Listings";
}

@if (Model.Count() == 0)
{
    <div class="page-header">
        <h3>It's lonely here... <small>Use the create button below to add some clients.</small></h3>
    </div>
}
else
{
        <table class="table">
            <tr>
                <th class="col-sm-3">
                    @Html.DisplayNameFor(model => model.Client.Name)
                </th>
                <th class="col-sm-3">
                    @Html.DisplayNameFor(model => model.Client.Link)
                </th>
                <th class="col-sm-2 text-center">
                    Create Date
                </th>
                <th class="col-sm-2 text-center">
                    Update Date
                </th>
                <th class="col-sm-2 text-center">
                    <span>Options</span>
                </th>
            </tr>
            @foreach (var item in Model)
            {
                <tr>
                    <td>
                        @Html.DisplayFor(modelItem => item.Client.Name)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.Client.Link)
                        @if (!string.IsNullOrWhiteSpace(item.Client.Link))
                        {
                            <a href="@item.Client.Link" target="_blank"><i class="fa fa-external-link" aria-hidden="true"></i></a>
                        }
                    </td>
                    <td class="text-center">
                        @Html.DisplayFor(modelItem => item.Client.CreateDate)
                    </td>
                    <td class="text-center">
                        @Html.DisplayFor(modelItem => item.Client.UpdateDate)
                    </td>
                    <td class="text-center optionsButtonGroup">
                        @if (User.IsInRole("Admin"))
                        {
                            <button type="button" id="inviteLaunchButton" class="btn btn-default" data-toggle="modal" data-target="#inviteUsers" data-clientId="@item.Client.Id" data-clientName="@item.Client.Name">
                               Invite Users <i class="fa fa-envelope-o" aria-hidden="true"></i>
                            </button>
                        }
                        <a href="@Url.Action("Details", new { id = item.Client.Id })" class="btn btn-default">
                            <i class="fa fa-info" aria-hidden="true"></i>
                        </a>
                        <a href="@Url.Action("ClientLocations", "Location", new { id = item.Client.Id })" class="btn btn-default">
                            Locations <i class="fa fa-globe" aria-hidden="true"></i>
                        </a>
                    </td>
                </tr>
            }
        </table>
        }

            @if (User.IsInRole("Admin"))
            {
                                            <!-- Modal -->
                <div class="modal fade" id="inviteUsers" tabindex="-1" role="dialog" aria-labelledby="inviteUsersLabel" aria-hidden="true">
                    <div class="modal-dialog text-left" role="document">
                        <div class="modal-content">
                            <div class="modal-body">
                                <h4 class="modal-title" id="inviteUsersLabel" style="display:inline-block;">Send User Registration Email For:&nbsp;</h4><h4 id="clientName" style="display:inline-block;"></h4>
                                <div>
                                    <small>An email will be sent to the address with a single use registration code and instructions to register for the site.</small>
                                </div>
                                <div style="margin-top:10px;">
                                    <label>New User Email</label>
                                    <input type="email" id="registerEmailInput" class="form-control" />
                                    <input type="text" id="registerEmailClientId" class="form-control hidden" disabled />
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button id="closeButton" type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                <button id="inviteButton" type="button" class="btn btn-success">Send Invitation</button>
                            </div>
                        </div>
                    </div>
                </div>
                <hr />
                <div class="row">
                    <div class="col-xs-12">
                        @Html.ActionLink("Create New Client", "Create", new { cId = ViewBag.ClientId, id = ViewBag.LocationId }, new { @class = "btn btn-default" })
                    </div>
                </div>
            }
<script>
    $(document).on('click', '#inviteButton', function(){
        inviteUser();
    });
    $(document).on('click', '#inviteLaunchButton', function () {
        var clientName = $(this).attr('data-clientName');
        var clientId = $(this).attr('data-clientId');
        $('#clientName').text(clientName);
        $('#registerEmailClientId').val(clientId);
    });

    function inviteUser() {
        var email = $('#registerEmailInput').val();
        var clientId = $('#registerEmailClientId').val();
        $('#errorMessage').addClass("hidden");
        $.ajax({
            type: "POST",
            url: 'IssueRegistration/' + clientId,
            data: { email: email },
            success: function(response){
                if (response) {
                    $('#closeButton').click();
                    $('#errorMessage').html("<i class=\"fa fa-exclamation-circle\" aria-hidden=\"true\"></i> <strong>Error!</strong> " + response);
                    $('#errorMessage').removeClass("hidden");
                } else {
                    $('#closeButton').click();
                    $.growl.notice({ message: "Successfully issued invitation!" });
                }
            },
            error: function () {
                $('#closeButton').click();
                $('#errorMessage').html("<i class=\"fa fa-exclamation-circle\" aria-hidden=\"true\"></i> <strong>Error!</strong> An unexpected error has occurred. Please try again later.");
                $('#errorMessage').removeClass("hidden");
            }
        });
    }
</script>